# HESS-gapy1

Scripts to use for data analysis with H.E.S.S. data using ``gammapy 1.1 LTS``.


## Usage

Create a conda environment with all the required packages using the following commands:

       conda env create --file environment.yaml
       conda activate gapy1

## Config Parameters

| Table            | Parameter                  | Type         | Unit    | Description                                                                                                                                                                                                                                                                              |
|------------------|----------------------------|--------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **[main]**       |
|                  | analysis_version           | str or int   | -       | Name the version, this will be reflected in the name of all files and the folder                                                                                                                                                                                                         |
|                  | create_logfile             | bool         | -       | If ``true``, console output will be saved in a separate file. Output in the console will be produced regardless of this setting.                                                                                                                                                         | 
|                  | check_tutorials_setup      | bool         | -       | If ``true``, a method will be run that will check if all packages are installed in order to run the gammapy tutorial                                                                                                                                                                     |
|                  | data_reduction_run_in_file | bool         | -       | If ``true``, the data reduction will be performed in the file you are executing. If ``false``, the data reduction will not be performed in the file and it will try to read from file. If this is the first time you are executing the file, you have to run the data reduction in file. | 
| **[datastore]**  |
|                  | path                       | str          | -       | Specify the path of the datastore                                                                                                                                                                                                                                                        |
|                  | filename                   | str          | -       | Default is ``"nan"``. Specify the HDU file name of the datastore. If set to ``"nan"``, the default, i.e. ``hdu-index.fits.gz`` will be selected.                                                                                                                                         |
|                  | required_irf               | str          | -       | Define which IRF parameters are required from the datastore. Options are ``"full-enclosure``, ``point-like``, and ``"all-optional"``.                                                                                                                                                    |
| **[hgps]**       |
|                  | run                        | bool         | -       | If ``true``, the High Galactic Plane Survey (HGPS) Catalogue data by H.E.S.S. will be used to search for nearby sources.                                                                                                                                                                 |
|                  | path                       | str          | -       | Specify the path of the HGPS fits file                                                                                                                                                                                                                                                   |
| **[source]**     |
|                  | name                       | str          | -       | Specify the source name. This will be reflected throughout the analysis. This will also be reflected in the name of all files and the folder.                                                                                                                                            |
|                  | get_position_from_config   | bool         | -       | If ``true``, the values below (``lon/lat``) for the position will be used. If ``false``, and the name is put precisely, then the position can be read from the database using the astropy library.                                                                                       |
|                  | lon                        | float        | deg     | Longitude or Right Ascension of source                                                                                                                                                                                                                                                   |
|                  | lat                        | float        | deg     | Latitude or Declination of source                                                                                                                                                                                                                                                        |
|                  | frame                      | str          | -       | Options:``"galactic"`` or ``"icrs"``. Frame of the source coordinates passed for ``lon``/``lat``, either ``"galactic"`` or ``"icrs"``. Note that the maps will always be in Galactic coordinates.                                                                                        |
|                  | radius                     | float        | deg     | Spatial extension of the source in deg. This will adjust the size fo the mask centred around the source position (``lon``/``lat``). This will also be reflected in the name of all files and the folder.                                                                                 |
| **[map]**        |
|                  | size                       | int          | deg     | Specify size of the maps that are produced. Default is ``5`` deg, which creates a 5x5 deg map.                                                                                                                                                                                           |
|                  | size_binsz                 | float        | deg     | Specify size of bins, default is ``0.02`` deg.                                                                                                                                                                                                                                           | 
| **[runlist]**    |
|                  | create_in_file             | bool         | -       | If ``true``, the runlist will be created while running the file according to the filters. If ``false`` the runlist will be loaded from disk.                                                                                                                                             |
|                  | filename                   | str          | -       | Specify the filename of the runlist that should be loaded from disk. Default is ``"nan"``, which will load the default name produced when ``create_in_file`` was set to ``true``.                                                                                                        | 
|                  | cone_radius                | float        | deg     | Default is ``5`` deg. Only relevant if ``create_in_file`` is ``true``.                                                                                                                                                                                                                   | 
|                  | filter.run                 | bool         | -       | Specify whether the filters below should be executed. If ``true`` all filters will be executed. Else, none of them will.                                                                                                                                                                 | 
|                  | filter.max_zenith          | int or float | -       | Default is ``"nan"``. Apply manual zenith angle filter to the runlist. Zenith angle observations above the input value will be filtered from the runlist. If ``filter.run`` is set to ``false``, this value will be ignored.                                                             | 
|                  | filter.years               | list         | -       | Default is ``["nan"]``. Apply manual yearly filter by specifying the year(s) of the raw data to use (max. 2 elements in list in the form of e.g. ``[2021, 2022]``).                                                                                                                      | 
|                  | filter.duration            | int or float | s       | Default is ``"nan"``. Standard duration for H.E.S.S. is ``1682.0`` s. Apply manual duration filter by specifying the minimum run duration in seconds. Runs shorter than this will be filtered out.                                                                                       | 
|                  | filter.number              | int          | -       | Default is ``"nan"``. Apply manual number filter to the runlist. Only the specified number of runs will be used. This filter will be applied last. If ``filter.run`` is set to ``false``, this value will be ignored.                                                                    | 
| **[energy]**     |
|                  | low                        | float        | TeV     | Define measured energy range in TeV (low, high, number of bins)                                                                                                                                                                                                                          |
|                  | high                       | float        | TeV     | Define measured energy range in TeV (low, high, number of bins)                                                                                                                                                                                                                          | 
|                  | nbin                       | int          | -       | Define measured energy range in TeV (low, high, number of bins)                                                                                                                                                                                                                          | 
|                  | true_low                   | float        | TeV     | Define true energy range (reduced IRFs are defined in true energy (i.e. not measured energy)). Measured energy range has to be fully encompassed by true energy range.                                                                                                                   |
|                  | true_high                  | float        | TeV     | Define true energy range (reduced IRFs are defined in true energy (i.e. not measured energy)). Measured energy range has to be fully encompassed by true energy range.                                                                                                                   | 
|                  | true_nbin                  | int          | -       | Define true energy range (reduced IRFs are defined in true energy (i.e. not measured energy)). Measured energy range has to be fully encompassed by true energy range.                                                                                                                   | 
| **[background]** |
|                  | method                     | str          | -       | Options: field-of-view (``"fov"``) or reflected (``"reflected"``) background methods. This choice will also show in the file names.                                                                                                                                                      |
|                  | mask.add                   | bool         | -       | Whether or not a mask with the coordinates specified in ``mask.lon``/ ``mask.lat`` should added additionally to the default mask for background estimation.                                                                                                                              |
|                  | mask.lon                   | float        | deg     | Longitude of mask                                                                                                                                                                                                                                                                        |
|                  | mask.lat                   | float        | deg     | Latitude of mask                                                                                                                                                                                                                                                                         |
|                  | mask.frame                 | str          | -       | Options:``"galactic"``. Frame of the mask coordinates passed for ``lon``/``lat``, either ``"galactic"``. Note that the maps will always be in Galactic coordinates.                                                                                                                      |
|                  | mask.radius                | float        | deg     | Spatial extension of the mask in deg. This will adjust the size fo the mask centred around the source position (``lon``/``lat``). This will also be reflected in the name of all files and the folder.                                                                                   |
| **[model]**      |
|                  | run                        | bool         | -       | Whether or not to run the modelling section of the script.                                                                                                                                                                                                                               |
|                  | backend                    | str          | -       | Which fitting algorythm to be used. Options: ``"sherpa"``, ``"minuit"``.                                                                                                                                                                                                                 |
|                  | sed.energy_limit           | list(str)    | TeV     | Specify energy bounds of spectral energy distribution (SED) plot.                                                                                                                                                                                                                        |
|                  | sed.energy_nbins           | int          | -       | Specify number of energy bins for SED.                                                                                                                                                                                                                                                   |
| **[model0]**     |
|                  | name                       | str          | -       | Name of the first model. Usually this is the source model with the name being identical to the name chosen in ``[source].name``, in which case you can chose ``"default``.                                                                                                               |
|                  | spatial.name               | str          | -       | Which spatial model to use. Options currently are ``"PointSpatialModel"``, ``"DiskSpatialModel"``.                                                                                                                                                                                       |
|                  | spatial.lon.value          | str or float | - / deg | Initial lon position of spatial model. Default is ``default``, in which case the position from ``[source].lon`` will be used.                                                                                                                                                            |
|                  | spatial.lon.frozen         | bool         | -       | If ``true``, the lon position will be frozen for fitting. If ``true``, the lon position will be left free.                                                                                                                                                                               |
|                  | spatial.lat.value          | str or float | - / deg | Initial lat position of spatial model. Default is ``default``, in which case the position from ``[source].lat`` will be used.                                                                                                                                                            |
|                  | spatial.lat.frozen         | bool         | -       | If ``true``, the lon position will be frozen for fitting. If ``true``, the lon position will be left free.                                                                                                                                                                               |
|                  | spatial.lon.limit          | list(float)  | -       | E.g. ``[16.5, 18.5]``. Set spatial fitting range for lon.                                                                                                                                                                                                                                |
|                  | spatial.lat.limit          | list(float)  | -       | E.g. ``[16.5, 18.5]``. Set spatial fitting range for lat.                                                                                                                                                                                                                                |
|                  | spatial.radius.limit       | list(float)  | -       | E.g. ``[0.2, 1.0]``. Set spatial fitting range for radius of extended source.                                                                                                                                                                                                            |
|                  | spectral.name              | str          | -       | Which spatial model to use. Options currently are ``"PowerLawSpectralModel"``, ``"ExpCutoffPowerLawSpectralModel"``.                                                                                                                                                                     |
| **[model1]**     |
|                  | see above                  | -            | -       | Whole section is optional. Same options as for ``[model0]``. This is an additional model that will be fit.                                                                                                                                                                               |
| **[plot]**       |
|                  | show                       | bool         | -       | Whether or not to show the plots while running the script.                                                                                                                                                                                                                               |
|                  | export                     | bool         | -       | Whether or not to write the plots to disk.                                                                                                                                                                                                                                               |
|                  | dpi                        | int          | -       | Specify the resolution (dots per inch) that are wanted for the exported files written to disk.                                                                                                                                                                                           |
|                  | colours                    | list(str)    | -       | List of colours with hex codes that will be used to the plots.                                                                                                                                                                                                                           |



## Author
Christopher Burger-Scheidlin (cburger@cp.dias.ie)
